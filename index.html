
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Household Chores Manager</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2, h3, h4 {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 1rem;
        }
        
        h1 {
            font-size: 1.8rem;
            text-align: center;
            margin: 1.5rem 0;
            color: var(--primary-dark);
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        h1::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: var(--primary);
            margin: 0.5rem auto 0;
            border-radius: 2px;
        }
        
        h2 {
            font-size: 1.4rem;
            margin-bottom: 1.2rem;
        }
        
        /* Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
            transition: var(--transition);
            border: 1px solid var(--light-gray);
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* User Group Styles */
        .user-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .user-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-name i {
            color: var(--primary);
        }
        
        .completion-rate {
            font-size: 0.85rem;
            color: var(--gray);
            background: var(--light-gray);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .completion-rate.high {
            background: #ecfdf5;
            color: #059669;
        }
        
        .completion-rate.medium {
            background: #fffbeb;
            color: #d97706;
        }
        
        .completion-rate.low {
            background: #fef2f2;
            color: #dc2626;
        }
        
        /* Task List Styles */
        .task-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            background-color: white;
            border: 1px solid var(--light-gray);
            transition: var(--transition);
        }
        
        .task-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .task-checkbox {
            margin-right: 0.8rem;
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }
        
        .task-name {
            flex-grow: 1;
            word-break: break-word;
            padding: 0.2rem 0;
        }
        
        .task-frequency {
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            margin-left: 0.5rem;
            text-transform: capitalize;
        }
        
        .task-frequency.daily {
            background-color: var(--info);
        }
        
        .task-frequency.weekly {
            background-color: var(--secondary);
        }
        
        .task-frequency.monthly {
            background-color: var(--warning);
        }
        
        .completed {
            text-decoration: line-through;
            color: var(--gray);
            opacity: 0.8;
        }
        
        /* Week Indicator */
        .week-indicator {
            text-align: center;
            margin: 1.5rem 0;
            font-size: 1rem;
            color: var(--gray);
            background: white;
            padding: 0.8rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            font-weight: 500;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            gap: 0.5rem;
            text-align: center;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #0d9c6d;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d97706;
            transform: translateY(-2px);
        }
        
        .btn-block {
            display: flex;
            width: 100%;
            max-width: 300px;
            margin: 1rem auto;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        input, select {
            width: 100%;
            padding: 0.7rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .assign-controls {
            display: flex;
            gap: 0.8rem;
        }
        
        .assign-controls select {
            flex: 1;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 0.5rem;
        }
        
        .tab {
            padding: 0.6rem 1rem;
            background: var(--light);
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--gray);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: var(--light-gray);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Admin Monitoring */
        .admin-login {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: white;
            padding: 0.5rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }
        
        #admin-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: var(--transition);
        }
        
        #admin-toggle:hover {
            background: var(--primary-dark);
        }
        
        #admin-login-form {
            display: none;
            background: white;
            padding: 0.8rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            width: 250px;
        }
        
        #admin-login-form input {
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        #admin-login-form button {
            width: 100%;
            padding: 0.6rem;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .admin-view {
            display: none;
            background: white;
            color: var(--dark);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            box-shadow: var(--card-shadow);
        }
        
        /* Progress Grid */
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .progress-card {
            background: white;
            color: var(--dark);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--light-gray);
            transition: var(--transition);
        }
        
        .progress-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .progress-card h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .progress-card h4 i {
            color: var(--primary);
        }
        
        .progress-bar {
            height: 10px;
            background: var(--light-gray);
            border-radius: 10px;
            margin: 1rem 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--secondary);
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .frequency-stats {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        
        .frequency-stats p {
            margin: 0;
            font-size: 0.8rem;
            background: var(--light);
            padding: 0.4rem;
            border-radius: 6px;
            text-align: center;
            display: flex;
            flex-direction: column;
        }
        
        .frequency-stats p span {
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 0.2rem;
        }
        
        /* Sync Status */
        .sync-status {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: var(--dark);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            max-width: 80%;
            word-break: break-word;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }
        
        .sync-status i {
            font-size: 0.9rem;
        }
        
        .sync-status.syncing {
            background: var(--info);
        }
        
        .sync-status.success {
            background: var(--secondary);
        }
        
        .sync-status.error {
            background: var(--danger);
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .admin-mode .admin-only {
            display: block;
        }
        
        .admin-mode .rotate-btn {
            display: flex;
        }
        
        .admin-mode .admin-panel {
            display: block;
        }
        
        .non-admin .rotate-btn,
        .non-admin .admin-panel {
            display: none;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .mt-3 {
            margin-top: 1rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-3 {
            margin-bottom: 1rem;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .progress-grid {
                grid-template-columns: 1fr;
            }
            
            .assign-controls {
                flex-direction: column;
            }
            
            .admin-login {
                top: 10px;
                right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .tabs {
                gap: 0.3rem;
            }
            
            .tab {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="non-admin">
    <!-- Admin Login Toggle -->
    <div class="admin-login">
        <button id="admin-toggle"><i class="fas fa-lock"></i> Admin</button>
        <div id="admin-login-form" class="hidden">
            <input type="password" id="admin-password" placeholder="Enter admin password">
            <button id="admin-login-btn" class="btn btn-primary btn-block">Login</button>
            <button id="admin-logout-btn" class="btn btn-danger btn-block hidden">Logout</button>
        </div>
    </div>

    <div class="sync-status syncing" id="sync-status">
        <i class="fas fa-sync-alt fa-spin"></i> Syncing...
    </div>

    <div class="container">
        <h1><i class="fas fa-broom"></i> Household Chores Manager</h1>
        
        <div class="week-indicator">
            <i class="fas fa-calendar-week"></i> Current Week: <span id="current-week">1</span>
        </div>
        
        <div class="card" id="shared-container">
            <!-- All users' tasks will be displayed here together -->
        </div>
        
        <button class="btn btn-secondary btn-block admin-only" id="rotate-tasks">
            <i class="fas fa-sync"></i> Rotate Tasks for Next Week
        </button>
        
        <div class="card admin-panel admin-only">
            <div class="tabs">
                <div class="tab active" data-tab="add-task">
                    <i class="fas fa-plus"></i> Add Task
                </div>
                <div class="tab" data-tab="assign-task">
                    <i class="fas fa-user-tag"></i> Assign Task
                </div>
                <div class="tab" data-tab="manage-tasks">
                    <i class="fas fa-tasks"></i> Manage Tasks
                </div>
                <div class="tab" data-tab="manage-users">
                    <i class="fas fa-users"></i> Manage Users
                </div>
                <div class="tab" data-tab="progress-tracker">
                    <i class="fas fa-chart-line"></i> Progress
                </div>
            </div>
            
            <div class="tab-content active" id="add-task">
                <h2><i class="fas fa-plus-circle"></i> Add New Task</h2>
                <div class="form-group">
                    <label for="new-task-name">Task Name</label>
                    <input type="text" id="new-task-name" placeholder="Enter task name">
                </div>
                <div class="form-group">
                    <label for="new-task-frequency">Frequency</label>
                    <select id="new-task-frequency">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <button id="add-task-btn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Task
                </button>
            </div>
            
            <div class="tab-content" id="assign-task">
                <h2><i class="fas fa-user-tag"></i> Assign Task to User</h2>
                <div class="form-group">
                    <label for="assign-task-select">Select Task</label>
                    <select id="assign-task-select">
                        <!-- Tasks will be populated here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="assign-user-select">Assign to User</label>
                    <select id="assign-user-select">
                        <!-- Users will be populated here -->
                    </select>
                </div>
                <div class="assign-controls">
                    <button id="assign-task-btn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Assign
                    </button>
                    <button id="unassign-task-btn" class="btn btn-danger">
                        <i class="fas fa-user-minus"></i> Unassign
                    </button>
                </div>
            </div>
            
            <div class="tab-content" id="manage-tasks">
                <h2><i class="fas fa-tasks"></i> Manage Tasks</h2>
                <div class="form-group">
                    <label for="task-to-remove">Select Task to Remove</label>
                    <select id="task-to-remove">
                        <!-- Tasks will be populated here -->
                    </select>
                </div>
                <button id="remove-task-btn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Remove Task
                </button>
            </div>
            
            <div class="tab-content" id="manage-users">
                <h2><i class="fas fa-users-cog"></i> Manage Users</h2>
                <div class="form-group">
                    <label for="user-to-rename">Select User to Rename</label>
                    <select id="user-to-rename">
                        <!-- Users will be populated here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-user-name">New Name</label>
                    <input type="text" id="new-user-name" placeholder="Enter new name">
                </div>
                <button id="rename-user-btn" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Rename User
                </button>
                <button class="btn btn-warning mt-2" id="reset-users-btn">
                    <i class="fas fa-undo"></i> Reset User Names
                </button>
            </div>
            
            <div class="tab-content" id="progress-tracker">
                <h2><i class="fas fa-chart-pie"></i> Progress Monitoring</h2>
                <div class="admin-view" id="admin-dashboard">
                    <h3><i class="fas fa-home"></i> Household Completion Rates</h3>
                    <div class="progress-grid" id="progress-grid">
                        <!-- Progress cards will be generated here -->
                    </div>
                    <button class="btn btn-secondary mt-3" id="export-data">
                        <i class="fas fa-file-export"></i> Export Progress Data
                    </button>
                    <button class="btn btn-danger mt-2" id="reset-data-btn">
                        <i class="fas fa-trash"></i> Reset All Data
                    </button>
                </div>
                <div id="admin-message" class="text-center">
                    <p>Please login as admin to view progress tracking.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCi9sLJbYKFTSuw6IvFBePa0gbcQYrqoS8",
            authDomain: "jobs-list-225a7.firebaseapp.com",
            databaseURL: "https://jobs-list-225a7-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jobs-list-225a7",
            storageBucket: "jobs-list-225a7.appspot.com",
            messagingSenderId: "15469992980",
            appId: "1:15469992980:web:e4464c09c183b3f4251b01",
            measurementId: "G-Y1NTGTN88G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'householdData');

        // Configuration
        const ADMIN_PASSWORD = "household123";
        let isAdmin = false;

        // Default data structure
        const defaultData = {
            currentWeek: 1,
            users: [
                { id: 1, name: "User 1", tasks: [] },
                { id: 2, name: "User 2", tasks: [] },
                { id: 3, name: "User 3", tasks: [] },
                { id: 4, name: "User 4", tasks: [] },
                { id: 5, name: "User 5", tasks: [] }
            ],
            allTasks: [],
            lastResetDate: new Date().toISOString()
        };

        // Current app data
        let householdData = JSON.parse(JSON.stringify(defaultData));

        // DOM elements
        const sharedContainer = document.getElementById('shared-container');
        const currentWeekSpan = document.getElementById('current-week');
        const rotateBtn = document.getElementById('rotate-tasks');
        const addTaskBtn = document.getElementById('add-task-btn');
        const removeTaskBtn = document.getElementById('remove-task-btn');
        const assignTaskBtn = document.getElementById('assign-task-btn');
        const unassignTaskBtn = document.getElementById('unassign-task-btn');
        const renameUserBtn = document.getElementById('rename-user-btn');
        const resetUsersBtn = document.getElementById('reset-users-btn');
        const resetDataBtn = document.getElementById('reset-data-btn');
        const newTaskName = document.getElementById('new-task-name');
        const newTaskFrequency = document.getElementById('new-task-frequency');
        const taskToRemove = document.getElementById('task-to-remove');
        const assignTaskSelect = document.getElementById('assign-task-select');
        const assignUserSelect = document.getElementById('assign-user-select');
        const userToRename = document.getElementById('user-to-rename');
        const newUserName = document.getElementById('new-user-name');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const syncStatus = document.getElementById('sync-status');
        const adminToggle = document.getElementById('admin-toggle');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminPassword = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminMessage = document.getElementById('admin-message');
        const progressGrid = document.getElementById('progress-grid');
        const exportBtn = document.getElementById('export-data');
        const body = document.body;

        // Verify and repair data structure
        function verifyDataStructure() {
            if (!householdData) {
                householdData = JSON.parse(JSON.stringify(defaultData));
                return;
            }
            
            // Ensure currentWeek exists
            if (typeof householdData.currentWeek !== 'number') {
                householdData.currentWeek = defaultData.currentWeek;
            }
            
            // Ensure lastResetDate exists
            if (!householdData.lastResetDate) {
                householdData.lastResetDate = new Date().toISOString();
            }
            
            // Ensure users array exists and is properly structured
            if (!Array.isArray(householdData.users)) {
                householdData.users = JSON.parse(JSON.stringify(defaultData.users));
            } else {
                householdData.users.forEach(user => {
                    if (!user.id) user.id = Date.now();
                    if (!user.name) user.name = `User ${user.id}`;
                    if (!Array.isArray(user.tasks)) user.tasks = [];
                    
                    // Ensure each task has lastCompleted property
                    user.tasks.forEach(task => {
                        if (!task.lastCompleted) task.lastCompleted = null;
                    });
                });
            }
            
            // Ensure allTasks array exists and is properly structured
            if (!Array.isArray(householdData.allTasks)) {
                householdData.allTasks = [];
            } else {
                householdData.allTasks.forEach(task => {
                    if (!task.id) task.id = Date.now();
                    if (!task.name) task.name = "Unnamed Task";
                    if (!task.frequency) task.frequency = "weekly";
                    if (!Array.isArray(task.assignedUsers)) task.assignedUsers = [];
                });
            }
        }

        // Check if tasks need to be reset based on their frequency
        function checkForTaskResets() {
            const now = new Date();
            const lastResetDate = new Date(householdData.lastResetDate);
            const needsReset = {
                daily: false,
                weekly: false,
                monthly: false
            };

            // Check daily reset (if it's a new day)
            if (now.getDate() !== lastResetDate.getDate() || 
                now.getMonth() !== lastResetDate.getMonth() || 
                now.getFullYear() !== lastResetDate.getFullYear()) {
                needsReset.daily = true;
            }

            // Check weekly reset (if it's a new week and it's Sunday)
            if (now.getDay() === 0 && (now.getDate() !== lastResetDate.getDate() || 
                                       now.getMonth() !== lastResetDate.getMonth() || 
                                       now.getFullYear() !== lastResetDate.getFullYear())) {
                needsReset.weekly = true;
            }

            // Check monthly reset (if it's the 1st of the month)
            if (now.getDate() === 1 && (now.getMonth() !== lastResetDate.getMonth() || 
                                       now.getFullYear() !== lastResetDate.getFullYear())) {
                needsReset.monthly = true;
            }

            // If any reset is needed, update the tasks
            if (needsReset.daily || needsReset.weekly || needsReset.monthly) {
                householdData.users.forEach(user => {
                    user.tasks.forEach(task => {
                        if ((task.frequency === 'daily' && needsReset.daily) ||
                            (task.frequency === 'weekly' && needsReset.weekly) ||
                            (task.frequency === 'monthly' && needsReset.monthly)) {
                            task.completed = false;
                            task.lastCompleted = null;
                        }
                    });
                });

                // Update last reset date
                householdData.lastResetDate = now.toISOString();
                return true;
            }
            return false;
        }

        // Save to Realtime Database
        async function saveToDatabase() {
            try {
                updateSyncStatus("Saving to cloud...", "syncing");
                await set(dbRef, householdData);
                updateSyncStatus("Synced successfully", "success");
                setTimeout(() => syncStatus.textContent = "", 2000);
            } catch (error) {
                console.error("Error saving to database:", error);
                updateSyncStatus("Sync failed: " + error.message, "error");
            }
        }

        // Update sync status with visual feedback
        function updateSyncStatus(message, status) {
            syncStatus.textContent = message;
            syncStatus.className = "sync-status";
            syncStatus.classList.add(status);
            
            switch(status) {
                case "syncing":
                    syncStatus.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> ${message}`;
                    break;
                case "success":
                    syncStatus.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                    break;
                case "error":
                    syncStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                    break;
                default:
                    syncStatus.textContent = message;
            }
        }

        // Load from Realtime Database with improved error handling
        function loadFromDatabase() {
            updateSyncStatus("Loading from cloud...", "syncing");
            
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                console.log("Data received from Firebase:", data);
                
                if (data) {
                    // Merge with default structure to ensure all required fields exist
                    householdData = {
                        currentWeek: data.currentWeek || defaultData.currentWeek,
                        users: data.users || JSON.parse(JSON.stringify(defaultData.users)),
                        allTasks: data.allTasks || [],
                        lastResetDate: data.lastResetDate || new Date().toISOString()
                    };
                    
                    verifyDataStructure();
                    
                    // Check for task resets when loading
                    const resetPerformed = checkForTaskResets();
                    if (resetPerformed) {
                        saveToDatabase();
                    }
                    
                    saveDataLocally();
                    renderSharedView();
                    updateWeekDisplay();
                    populateDropdowns();
                    if (isAdmin) renderAdminDashboard();
                } else {
                    // No data exists - initialize with defaults
                    console.log("No data found, initializing new database");
                    householdData = JSON.parse(JSON.stringify(defaultData));
                    saveToDatabase();
                }
                
                updateSyncStatus("Synced successfully", "success");
                setTimeout(() => syncStatus.textContent = "", 2000);
            }, (error) => {
                console.error("Error loading data:", error);
                updateSyncStatus("Sync failed, using local data", "error");
                
                // Fallback to local data with proper initialization
                const saved = localStorage.getItem('householdChoresData');
                householdData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultData));
                verifyDataStructure();
                
                // Check for task resets when loading local data
                const resetPerformed = checkForTaskResets();
                if (resetPerformed) {
                    saveDataLocally();
                }
                
                renderSharedView();
            });
        }

        // Save to localStorage
        function saveDataLocally() {
            localStorage.setItem('householdChoresData', JSON.stringify(householdData));
        }

        // Combined save function
        async function saveAndSync() {
            verifyDataStructure();
            saveDataLocally();
            await saveToDatabase();
        }

        // Add a new task with validation
        async function addNewTask(name, frequency) {
            if (!name || !frequency) return;
            
            const newTask = {
                id: Date.now(),
                name: name.trim(),
                frequency: frequency,
                assignedUsers: []
            };
            
            if (!householdData.allTasks) {
                householdData.allTasks = [];
            }
            
            householdData.allTasks.push(newTask);
            await saveAndSync();
            populateDropdowns();
            newTaskName.focus();
        }

        // Assign task to user with validation
        async function assignTaskToUser(taskId, userId) {
            if (!taskId || !userId) return;
            
            const task = householdData.allTasks.find(t => t.id === taskId);
            const user = householdData.users.find(u => u.id === userId);
            
            if (!task || !user) return;
            
            // Initialize arrays if they don't exist
            if (!task.assignedUsers) task.assignedUsers = [];
            if (!user.tasks) user.tasks = [];
            
            if (!task.assignedUsers.includes(userId)) {
                task.assignedUsers.push(userId);
            }
            
            if (!user.tasks.some(t => t.id === taskId)) {
                user.tasks.push({
                    id: task.id,
                    name: task.name,
                    frequency: task.frequency,
                    completed: false,
                    lastCompleted: null
                });
            }
            
            await saveAndSync();
            renderSharedView();
            if (isAdmin) renderAdminDashboard();
        }

        // Render shared view of all users' tasks
        function renderSharedView() {
            sharedContainer.innerHTML = '';
            
            if (!householdData?.users) {
                console.error("Users data is missing!");
                return;
            }
            
            // Use current data or fallback to defaults
            const users = householdData.users.length > 0 ? householdData.users : defaultData.users;
            
            users.forEach(user => {
                const tasks = user.tasks || [];
                const totalTasks = tasks.length;
                const completedTasks = tasks.filter(t => t?.completed).length;
                const completionRate = totalTasks > 0 
                    ? Math.round((completedTasks / totalTasks) * 100) 
                    : 0;
                
                // Determine completion rate class
                let completionClass = '';
                if (completionRate >= 75) completionClass = 'high';
                else if (completionRate >= 50) completionClass = 'medium';
                else if (completionRate > 0) completionClass = 'low';
                
                const userGroup = document.createElement('div');
                userGroup.className = 'user-group';
                
                const userHeader = document.createElement('div');
                userHeader.className = 'user-header';
                
                const userName = document.createElement('div');
                userName.className = 'user-name';
                userName.innerHTML = `<i class="fas fa-user"></i> ${user.name}`;
                
                const completionBadge = document.createElement('div');
                completionBadge.className = `completion-rate ${completionClass}`;
                completionBadge.innerHTML = `<i class="fas ${completionRate === 100 ? 'fa-check-circle' : 'fa-chart-pie'}"></i> ${completionRate}% completed`;
                
                userHeader.appendChild(userName);
                userHeader.appendChild(completionBadge);
                userGroup.appendChild(userHeader);
                
                const taskList = document.createElement('ul');
                taskList.className = 'task-list';
                
                if (tasks.length === 0) {
                    const emptyMessage = document.createElement('li');
                    emptyMessage.className = 'task-item';
                    emptyMessage.textContent = 'No tasks assigned';
                    taskList.appendChild(emptyMessage);
                } else {
                    tasks.forEach(task => {
                        const taskItem = document.createElement('li');
                        taskItem.className = 'task-item';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'task-checkbox';
                        checkbox.checked = task.completed || false;
                        checkbox.addEventListener('change', async () => {
                            task.completed = checkbox.checked;
                            task.lastCompleted = task.completed ? new Date().toISOString() : null;
                            await saveAndSync();
                            renderSharedView();
                            if (isAdmin) renderAdminDashboard();
                        });
                        
                        const taskName = document.createElement('span');
                        taskName.className = `task-name ${task.completed ? 'completed' : ''}`;
                        taskName.textContent = task.name;
                        
                        const frequencyBadge = document.createElement('span');
                        frequencyBadge.className = `task-frequency ${task.frequency}`;
                        frequencyBadge.textContent = task.frequency;
                        
                        taskItem.appendChild(checkbox);
                        taskItem.appendChild(taskName);
                        taskItem.appendChild(frequencyBadge);
                        taskList.appendChild(taskItem);
                    });
                }
                
                userGroup.appendChild(taskList);
                sharedContainer.appendChild(userGroup);
            });
        }

        // Update user name with validation
        async function updateUserName(userId, newName) {
            if (!userId || !newName) return;
            
            const user = householdData.users.find(u => u.id === userId);
            if (user && newName.trim()) {
                user.name = newName.trim();
                await saveAndSync();
                renderSharedView();
                populateDropdowns();
                if (isAdmin) renderAdminDashboard();
            }
        }

        // Reset all user names to defaults
        async function resetUserNames() {
            if (!confirm("Are you sure you want to reset all user names to defaults?")) return;
            
            householdData.users.forEach((user, index) => {
                user.name = `User ${index + 1}`;
            });
            
            await saveAndSync();
            renderSharedView();
            populateDropdowns();
            if (isAdmin) renderAdminDashboard();
        }

        // Reset all data to defaults
        async function resetAllData() {
            if (!confirm("WARNING: This will delete ALL data and reset to defaults. Continue?")) return;
            
            householdData = JSON.parse(JSON.stringify(defaultData));
            await saveAndSync();
            renderSharedView();
            updateWeekDisplay();
            populateDropdowns();
            if (isAdmin) renderAdminDashboard();
        }

        // Update week display
        function updateWeekDisplay() {
            currentWeekSpan.textContent = householdData.currentWeek || 1;
        }

        // Remove a task with validation
        async function removeTask() {
            const taskId = parseInt(taskToRemove.value);
            if (!taskId) return;
            
            if (!confirm("Are you sure you want to remove this task? This will also unassign it from all users.")) return;
            
            householdData.allTasks = householdData.allTasks.filter(task => task.id !== taskId);
            
            householdData.users.forEach(user => {
                user.tasks = user.tasks.filter(task => task.id !== taskId);
            });
            
            await saveAndSync();
            renderSharedView();
            populateDropdowns();
            if (isAdmin) renderAdminDashboard();
        }

        // Unassign task from user with validation
        async function unassignTaskFromUser(taskId, userId) {
            if (!taskId || !userId) return;
            
            const task = householdData.allTasks.find(t => t.id === taskId);
            const user = householdData.users.find(u => u.id === userId);
            
            if (!task || !user) return;
            
            task.assignedUsers = task.assignedUsers.filter(id => id !== userId);
            user.tasks = user.tasks.filter(t => t.id !== taskId);
            
            await saveAndSync();
            renderSharedView();
            if (isAdmin) renderAdminDashboard();
        }

        // Rotate tasks to next week with validation
        async function rotateTasks() {
            if (!confirm("Are you sure you want to rotate tasks for the next week? This will reassign all tasks to the next user in rotation.")) return;
            
            if (!householdData.currentWeek) {
                householdData.currentWeek = 1;
            } else {
                householdData.currentWeek++;
            }
            
            householdData.allTasks.forEach(task => {
                if (task.assignedUsers?.length > 0) {
                    // Remove task from all users first
                    householdData.users.forEach(user => {
                        user.tasks = user.tasks.filter(t => t.id !== task.id);
                    });
                    
                    // Rotate assignment
                    const firstUser = task.assignedUsers.shift();
                    task.assignedUsers.push(firstUser);
                    
                    // Reassign to all assigned users
                    task.assignedUsers.forEach(userId => {
                        const user = householdData.users.find(u => u.id === userId);
                        if (user) {
                            user.tasks.push({
                                id: task.id,
                                name: task.name,
                                frequency: task.frequency,
                                completed: false,
                                lastCompleted: null
                            });
                        }
                    });
                }
            });
            
            await saveAndSync();
            renderSharedView();
            updateWeekDisplay();
            if (isAdmin) renderAdminDashboard();
        }

        // Populate all dropdowns with validation
        function populateDropdowns() {
            if (!taskToRemove || !assignTaskSelect || !userToRename || !assignUserSelect) return;
            
            taskToRemove.innerHTML = '<option value="">Select a task</option>';
            assignTaskSelect.innerHTML = '<option value="">Select a task</option>';
            userToRename.innerHTML = '<option value="">Select a user</option>';
            assignUserSelect.innerHTML = '<option value="">Select a user</option>';
            
            householdData.allTasks?.forEach(task => {
                const option1 = document.createElement('option');
                option1.value = task.id;
                option1.textContent = task.name;
                taskToRemove.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = task.id;
                option2.textContent = task.name;
                assignTaskSelect.appendChild(option2);
            });
            
            householdData.users?.forEach(user => {
                const option1 = document.createElement('option');
                option1.value = user.id;
                option1.textContent = user.name;
                assignUserSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = user.id;
                option2.textContent = user.name;
                userToRename.appendChild(option2);
            });
        }

        // Set up tab switching
        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'progress-tracker') {
                        renderAdminDashboard();
                    }
                });
            });
        }

        // Admin dashboard rendering
        function renderAdminDashboard() {
            if (!adminDashboard || !adminMessage) return;
            
            if (!isAdmin) {
                adminDashboard.style.display = "none";
                adminMessage.style.display = "block";
                return;
            }
            
            adminDashboard.style.display = "block";
            adminMessage.style.display = "none";
            if (!progressGrid) return;
            
            progressGrid.innerHTML = '';
            
            householdData.users?.forEach(user => {
                const tasks = user.tasks || [];
                const totalTasks = tasks.length;
                const completedTasks = tasks.filter(t => t?.completed).length;
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                const frequencyStats = {
                    daily: { total: 0, completed: 0 },
                    weekly: { total: 0, completed: 0 },
                    monthly: { total: 0, completed: 0 }
                };
                
                tasks.forEach(task => {
                    if (task.frequency && frequencyStats[task.frequency]) {
                        frequencyStats[task.frequency].total++;
                        if (task.completed) frequencyStats[task.frequency].completed++;
                    }
                });
                
                const card = document.createElement('div');
                card.className = 'progress-card';
                
                card.innerHTML = `
                    <h4><i class="fas fa-user"></i> ${user.name}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${completionRate}%"></div>
                    </div>
                    <p>${completionRate}% Overall Completion</p>
                    <div class="frequency-stats">
                        <p>Daily <span>${frequencyStats.daily.completed}/${frequencyStats.daily.total}</span></p>
                        <p>Weekly <span>${frequencyStats.weekly.completed}/${frequencyStats.weekly.total}</span></p>
                        <p>Monthly <span>${frequencyStats.monthly.completed}/${frequencyStats.monthly.total}</span></p>
                    </div>
                `;
                
                progressGrid.appendChild(card);
            });
        }

        // Export progress data
        function exportProgressData() {
            if (!isAdmin) return;
            
            const data = {
                timestamp: new Date().toISOString(),
                week: householdData.currentWeek || 1,
                lastResetDate: householdData.lastResetDate,
                users: householdData.users?.map(user => {
                    const tasks = user.tasks || [];
                    return {
                        name: user.name,
                        completionRate: Math.round((tasks.filter(t => t?.completed).length / tasks.length) * 100) || 0,
                        tasks: tasks.map(task => ({
                            name: task.name,
                            frequency: task.frequency,
                            completed: task.completed,
                            lastCompleted: task.lastCompleted || "Never"
                        }))
                    };
                }) || []
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `household-progress-week-${householdData.currentWeek || 1}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Admin features setup
        function setupAdminFeatures() {
            if (!adminToggle || !adminLoginBtn || !adminLogoutBtn) return;
            
            adminToggle.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent event bubbling
                adminLoginForm.classList.toggle('hidden');
            });
            
            adminLoginBtn.addEventListener('click', () => {
                if (adminPassword.value === ADMIN_PASSWORD) {
                    isAdmin = true;
                    adminLoginForm.classList.add('hidden');
                    adminToggle.innerHTML = '<i class="fas fa-user-shield"></i> Admin Mode';
                    adminToggle.style.background = "#10b981";
                    adminLogoutBtn.classList.remove('hidden');
                    adminLoginBtn.classList.add('hidden');
                    body.classList.remove('non-admin');
                    body.classList.add('admin-mode');
                    renderAdminDashboard();
                    updateSyncStatus("Admin mode activated", "success");
                } else {
                    updateSyncStatus("Incorrect password", "error");
                }
            });
            
            adminLogoutBtn.addEventListener('click', () => {
                isAdmin = false;
                adminToggle.innerHTML = '<i class="fas fa-lock"></i> Admin';
                adminToggle.style.background = "";
                adminLogoutBtn.classList.add('hidden');
                adminLoginBtn.classList.remove('hidden');
                adminPassword.value = "";
                body.classList.remove('admin-mode');
                body.classList.add('non-admin');
                renderAdminDashboard();
                updateSyncStatus("Admin mode deactivated", "success");
            });
            
            // Close admin login form when clicking outside
            document.addEventListener('click', (e) => {
                if (!adminLoginForm.contains(e.target) && e.target !== adminToggle) {
                    adminLoginForm.classList.add('hidden');
                }
            });
            
            if (exportBtn) exportBtn.addEventListener('click', exportProgressData);
            if (resetUsersBtn) resetUsersBtn.addEventListener('click', resetUserNames);
            if (resetDataBtn) resetDataBtn.addEventListener('click', resetAllData);
        }

        // Set up event listeners with validation
        function setupEventListeners() {
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', async () => {
                    const name = newTaskName?.value?.trim();
                    const frequency = newTaskFrequency?.value;
                    
                    if (name && frequency) {
                        await addNewTask(name, frequency);
                        if (newTaskName) newTaskName.value = '';
                    } else {
                        updateSyncStatus("Please enter a task name", "error");
                    }
                });
                
                // Allow adding task with Enter key
                newTaskName.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const name = newTaskName?.value?.trim();
                        const frequency = newTaskFrequency?.value;
                        
                        if (name && frequency) {
                            await addNewTask(name, frequency);
                            if (newTaskName) newTaskName.value = '';
                        }
                    }
                });
            }
            
            if (removeTaskBtn) {
                removeTaskBtn.addEventListener('click', async () => {
                    await removeTask();
                });
            }
            
            if (assignTaskBtn) {
                assignTaskBtn.addEventListener('click', async () => {
                    const taskId = parseInt(assignTaskSelect?.value);
                    const userId = parseInt(assignUserSelect?.value);
                    
                    if (taskId && userId) {
                        await assignTaskToUser(taskId, userId);
                    } else {
                        updateSyncStatus("Please select both task and user", "error");
                    }
                });
            }
            
            if (unassignTaskBtn) {
                unassignTaskBtn.addEventListener('click', async () => {
                    const taskId = parseInt(assignTaskSelect?.value);
                    const userId = parseInt(assignUserSelect?.value);
                    
                    if (taskId && userId) {
                        await unassignTaskFromUser(taskId, userId);
                    } else {
                        updateSyncStatus("Please select both task and user", "error");
                    }
                });
            }
            
            if (renameUserBtn) {
                renameUserBtn.addEventListener('click', async () => {
                    const userId = parseInt(userToRename?.value);
                    const newName = newUserName?.value?.trim();
                    
                    if (userId && newName) {
                        await updateUserName(userId, newName);
                        if (newUserName) newUserName.value = '';
                    } else {
                        updateSyncStatus("Please select user and enter new name", "error");
                    }
                });
            }
            
            if (rotateBtn) {
                rotateBtn.addEventListener('click', async () => {
                    await rotateTasks();
                });
            }
        }

        // Initialize the app with error handling
        function initApp() {
            try {
                // Load data first
                loadFromDatabase();
                
                // Verify data structure
                verifyDataStructure();
                
                // Setup UI
                renderSharedView();
                updateWeekDisplay();
                populateDropdowns();
                
                // Setup functionality
                setupEventListeners();
                setupTabs();
                setupAdminFeatures();
                
                // Check for task resets periodically (every hour)
                setInterval(() => {
                    const resetPerformed = checkForTaskResets();
                    if (resetPerformed) {
                        saveAndSync();
                        renderSharedView();
                        if (isAdmin) renderAdminDashboard();
                    }
                }, 3600000); // 1 hour in milliseconds
                
            } catch (error) {
                console.error("App initialization failed:", error);
                updateSyncStatus("Initialization error - check console", "error");
            }
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
