<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Household Chores Manager</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-top: 40px;
        }
        .shared-view {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .user-group {
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        .user-group:last-child {
            border-bottom: none;
        }
        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .user-name {
            font-weight: bold;
            font-size: 1.3em;
            color: #3498db;
            margin-right: 15px;
        }
        .completion-rate {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .task-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .task-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
        }
        .task-item:hover {
            background-color: #f0f0f0;
        }
        .task-checkbox {
            margin-right: 15px;
            transform: scale(1.2);
        }
        .task-name {
            flex-grow: 1;
        }
        .task-frequency {
            font-size: 0.8em;
            color: white;
            background-color: #7f8c8d;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }
        .completed {
            text-decoration: line-through;
            color: #95a5a6;
        }
        .week-indicator {
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
            color: #7f8c8d;
        }
        .rotate-btn {
            background-color: #27ae60;
            max-width: 200px;
            margin: 20px auto;
            display: block;
            padding: 10px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .rotate-btn:hover {
            background-color: #219653;
        }
        .admin-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .assign-controls {
            display: flex;
            gap: 10px;
        }
        .assign-controls select {
            flex: 1;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            background: #ddd;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .tab.active {
            background: white;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Admin monitoring styles */
        .admin-login {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .admin-view {
            display: none;
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .progress-card {
            background: white;
            color: #2c3e50;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .progress-bar {
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #27ae60;
            transition: width 0.5s ease;
        }
        .export-btn {
            background: #e67e22;
            margin-top: 20px;
        }
        .export-btn:hover {
            background: #d35400;
        }
        .hidden {
            display: none;
        }
        .frequency-stats {
            margin-top: 10px;
        }
        .frequency-stats p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        #admin-login-form {
            margin-top: 10px;
        }
        #admin-login-form input {
            margin-bottom: 5px;
        }
        .sync-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .reset-btn {
            background: #e74c3c;
            margin-top: 10px;
        }
        .reset-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <!-- Admin Login Toggle -->
    <div class="admin-login">
        <button id="admin-toggle">Admin Mode</button>
        <div id="admin-login-form" class="hidden">
            <input type="password" id="admin-password" placeholder="Enter admin password">
            <button id="admin-login-btn">Login</button>
        </div>
    </div>

    <div class="sync-status" id="sync-status">Syncing...</div>

    <h1>Household Chores Manager</h1>
    
    <div class="week-indicator">
        Current Week: <span id="current-week">1</span>
    </div>
    
    <div class="shared-view" id="shared-container">
        <!-- All users' tasks will be displayed here together -->
    </div>
    
    <button class="rotate-btn" id="rotate-tasks">Rotate Tasks for Next Week</button>
    
    <div class="admin-panel">
        <div class="tabs">
            <div class="tab active" data-tab="add-task">Add Task</div>
            <div class="tab" data-tab="assign-task">Assign Task</div>
            <div class="tab" data-tab="manage-tasks">Manage Tasks</div>
            <div class="tab" data-tab="manage-users">Manage Users</div>
            <div class="tab" data-tab="progress-tracker">Progress Tracker</div>
        </div>
        
        <div class="tab-content active" id="add-task">
            <h2>Add New Task</h2>
            <div class="form-group">
                <label for="new-task-name">Task Name:</label>
                <input type="text" id="new-task-name" placeholder="Enter task name">
            </div>
            <div class="form-group">
                <label for="new-task-frequency">Frequency:</label>
                <select id="new-task-frequency">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>
            <button id="add-task-btn">Add Task</button>
        </div>
        
        <div class="tab-content" id="assign-task">
            <h2>Assign Task to User</h2>
            <div class="form-group">
                <label for="assign-task-select">Select Task:</label>
                <select id="assign-task-select">
                    <!-- Tasks will be populated here -->
                </select>
            </div>
            <div class="form-group">
                <label for="assign-user-select">Assign to User:</label>
                <select id="assign-user-select">
                    <!-- Users will be populated here -->
                </select>
            </div>
            <div class="assign-controls">
                <button id="assign-task-btn">Assign Task</button>
                <button id="unassign-task-btn">Unassign Task</button>
            </div>
        </div>
        
        <div class="tab-content" id="manage-tasks">
            <h2>Manage Tasks</h2>
            <div class="form-group">
                <label for="task-to-remove">Select Task to Remove:</label>
                <select id="task-to-remove">
                    <!-- Tasks will be populated here -->
                </select>
            </div>
            <button id="remove-task-btn">Remove Task</button>
        </div>
        
        <div class="tab-content" id="manage-users">
            <h2>Manage Users</h2>
            <div class="form-group">
                <label for="user-to-rename">Select User to Rename:</label>
                <select id="user-to-rename">
                    <!-- Users will be populated here -->
                </select>
            </div>
            <div class="form-group">
                <label for="new-user-name">New Name:</label>
                <input type="text" id="new-user-name" placeholder="Enter new name">
            </div>
            <button id="rename-user-btn">Rename User</button>
            <button class="reset-btn" id="reset-users-btn">Reset User Names</button>
        </div>
        
        <div class="tab-content" id="progress-tracker">
            <h2>Progress Monitoring</h2>
            <div class="admin-view" id="admin-dashboard">
                <h3>Household Completion Rates</h3>
                <div class="progress-grid" id="progress-grid">
                    <!-- Progress cards will be generated here -->
                </div>
                <button class="export-btn" id="export-data">Export Progress Data</button>
                <button class="reset-btn" id="reset-data-btn">Reset All Data</button>
            </div>
            <div id="admin-message">
                <p>Please enable admin mode to view progress tracking.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCi9sLJbYKFTSuw6IvFBePa0gbcQYrqoS8",
            authDomain: "jobs-list-225a7.firebaseapp.com",
            databaseURL: "https://jobs-list-225a7-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jobs-list-225a7",
            storageBucket: "jobs-list-225a7.appspot.com",
            messagingSenderId: "15469992980",
            appId: "1:15469992980:web:e4464c09c183b3f4251b01",
            measurementId: "G-Y1NTGTN88G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'householdData');

        // Configuration
        const ADMIN_PASSWORD = "household123";
        let isAdmin = false;

        // Default data structure
        const defaultData = {
            currentWeek: 1,
            users: [
                { id: 1, name: "User 1", tasks: [] },
                { id: 2, name: "User 2", tasks: [] },
                { id: 3, name: "User 3", tasks: [] },
                { id: 4, name: "User 4", tasks: [] },
                { id: 5, name: "User 5", tasks: [] }
            ],
            allTasks: []
        };

        // Current app data
        let householdData = JSON.parse(JSON.stringify(defaultData));

        // DOM elements
        const sharedContainer = document.getElementById('shared-container');
        const currentWeekSpan = document.getElementById('current-week');
        const rotateBtn = document.getElementById('rotate-tasks');
        const addTaskBtn = document.getElementById('add-task-btn');
        const removeTaskBtn = document.getElementById('remove-task-btn');
        const assignTaskBtn = document.getElementById('assign-task-btn');
        const unassignTaskBtn = document.getElementById('unassign-task-btn');
        const renameUserBtn = document.getElementById('rename-user-btn');
        const resetUsersBtn = document.getElementById('reset-users-btn');
        const resetDataBtn = document.getElementById('reset-data-btn');
        const newTaskName = document.getElementById('new-task-name');
        const newTaskFrequency = document.getElementById('new-task-frequency');
        const taskToRemove = document.getElementById('task-to-remove');
        const assignTaskSelect = document.getElementById('assign-task-select');
        const assignUserSelect = document.getElementById('assign-user-select');
        const userToRename = document.getElementById('user-to-rename');
        const newUserName = document.getElementById('new-user-name');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const syncStatus = document.getElementById('sync-status');
        const adminToggle = document.getElementById('admin-toggle');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminPassword = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminMessage = document.getElementById('admin-message');
        const progressGrid = document.getElementById('progress-grid');
        const exportBtn = document.getElementById('export-data');

        // Verify and repair data structure
        function verifyDataStructure() {
            if (!householdData) {
                householdData = JSON.parse(JSON.stringify(defaultData));
                return;
            }
            
            // Ensure currentWeek exists
            if (typeof householdData.currentWeek !== 'number') {
                householdData.currentWeek = defaultData.currentWeek;
            }
            
            // Ensure users array exists and is properly structured
            if (!Array.isArray(householdData.users)) {
                householdData.users = JSON.parse(JSON.stringify(defaultData.users));
            } else {
                householdData.users.forEach(user => {
                    if (!user.id) user.id = Date.now();
                    if (!user.name) user.name = `User ${user.id}`;
                    if (!Array.isArray(user.tasks)) user.tasks = [];
                });
            }
            
            // Ensure allTasks array exists and is properly structured
            if (!Array.isArray(householdData.allTasks)) {
                householdData.allTasks = [];
            } else {
                householdData.allTasks.forEach(task => {
                    if (!task.id) task.id = Date.now();
                    if (!task.name) task.name = "Unnamed Task";
                    if (!task.frequency) task.frequency = "weekly";
                    if (!Array.isArray(task.assignedUsers)) task.assignedUsers = [];
                });
            }
        }

        // Save to Realtime Database
        async function saveToDatabase() {
            try {
                syncStatus.textContent = "Saving to cloud...";
                await set(dbRef, householdData);
                syncStatus.textContent = "Synced";
                setTimeout(() => syncStatus.textContent = "", 2000);
            } catch (error) {
                console.error("Error saving to database:", error);
                syncStatus.textContent = "Sync failed: " + error.message;
            }
        }

        // Load from Realtime Database with improved error handling
        function loadFromDatabase() {
            syncStatus.textContent = "Loading from cloud...";
            
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                console.log("Data received from Firebase:", data);
                
                if (data) {
                    // Merge with default structure to ensure all required fields exist
                    householdData = {
                        currentWeek: data.currentWeek || defaultData.currentWeek,
                        users: data.users || JSON.parse(JSON.stringify(defaultData.users)),
                        allTasks: data.allTasks || []
                    };
                    
                    verifyDataStructure();
                    saveDataLocally();
                    renderSharedView();
                    updateWeekDisplay();
                    populateDropdowns();
                    if (isAdmin) renderAdminDashboard();
                } else {
                    // No data exists - initialize with defaults
                    console.log("No data found, initializing new database");
                    householdData = JSON.parse(JSON.stringify(defaultData));
                    saveToDatabase();
                }
                
                syncStatus.textContent = "Synced";
                setTimeout(() => syncStatus.textContent = "", 2000);
            }, (error) => {
                console.error("Error loading data:", error);
                syncStatus.textContent = "Sync failed, using local data";
                
                // Fallback to local data with proper initialization
                const saved = localStorage.getItem('householdChoresData');
                householdData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultData));
                verifyDataStructure();
                renderSharedView();
            });
        }

        // Save to localStorage
        function saveDataLocally() {
            localStorage.setItem('householdChoresData', JSON.stringify(householdData));
        }

        // Combined save function
        async function saveAndSync() {
            verifyDataStructure();
            saveDataLocally();
            await saveToDatabase();
        }

        // Add a new task with validation
        async function addNewTask(name, frequency) {
            if (!name || !frequency) return;
            
            const newTask = {
                id: Date.now(),
                name: name.trim(),
                frequency: frequency,
                assignedUsers: []
            };
            
            if (!householdData.allTasks) {
                householdData.allTasks = [];
            }
            
            householdData.allTasks.push(newTask);
            await saveAndSync();
            populateDropdowns();
        }

        // Assign task to user with validation
        async function assignTaskToUser(taskId, userId) {
            if (!taskId || !userId) return;
            
            const task = householdData.allTasks.find(t => t.id === taskId);
            const user = householdData.users.find(u => u.id === userId);
            
            if (!task || !user) return;
            
            // Initialize arrays if they don't exist
            if (!task.assignedUsers) task.assignedUsers = [];
            if (!user.tasks) user.tasks = [];
            
            if (!task.assignedUsers.includes(userId)) {
                task.assignedUsers.push(userId);
            }
            
            if (!user.tasks.some(t => t.id === taskId)) {
                user.tasks.push({
                    id: task.id,
                    name: task.name,
                    frequency: task.frequency,
                    completed: false
                });
            }
            
            await saveAndSync();
            renderSharedView();
            if (isAdmin) renderAdminDashboard();
        }

        // Render shared view of all users' tasks
        function renderSharedView() {
            sharedContainer.innerHTML = '';
            
            if (!householdData?.users) {
                console.error("Users data is missing!");
                return;
            }
            
            // Use current data or fallback to defaults
            const users = householdData.users.length > 0 ? householdData.users : defaultData.users;
            
            users.forEach(user => {
                const tasks = user.tasks || [];
                const totalTasks = tasks.length;
                const completedTasks = tasks.filter(t => t?.completed).length;
                const completionRate = totalTasks > 0 
                    ? Math.round((completedTasks / totalTasks) * 100) 
                    : 0;
                
                const userGroup = document.createElement('div');
                userGroup.className = 'user-group';
                
                const userHeader = document.createElement('div');
                userHeader.className = 'user-header';
                
                const userName = document.createElement('div');
                userName.className = 'user-name';
                userName.textContent = user.name;
                
                const completionBadge = document.createElement('div');
                completionBadge.className = 'completion-rate';
                completionBadge.textContent = `${completionRate}% completed`;
                
                userHeader.appendChild(userName);
                userHeader.appendChild(completionBadge);
                userGroup.appendChild(userHeader);
                
                const taskList = document.createElement('ul');
                taskList.className = 'task-list';
                
                tasks.forEach(task => {
                    const taskItem = document.createElement('li');
                    taskItem.className = 'task-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'task-checkbox';
                    checkbox.checked = task.completed || false;
                    checkbox.addEventListener('change', async () => {
                        task.completed = checkbox.checked;
                        await saveAndSync();
                        renderSharedView();
                        if (isAdmin) renderAdminDashboard();
                    });
                    
                    const taskName = document.createElement('span');
                    taskName.className = `task-name ${task.completed ? 'completed' : ''}`;
                    taskName.textContent = task.name;
                    
                    const frequencyBadge = document.createElement('span');
                    frequencyBadge.className = 'task-frequency';
                    frequencyBadge.textContent = task.frequency;
                    
                    taskItem.appendChild(checkbox);
                    taskItem.appendChild(taskName);
                    taskItem.appendChild(frequencyBadge);
                    taskList.appendChild(taskItem);
                });
                
                userGroup.appendChild(taskList);
                sharedContainer.appendChild(userGroup);
            });
        }

        // Update user name with validation
        async function updateUserName(userId, newName) {
            if (!userId || !newName) return;
            
            const user = householdData.users.find(u => u.id === userId);
            if (user && newName.trim()) {
                user.name = newName.trim();
                await saveAndSync();
                renderSharedView();
                populateDropdowns();
                if (isAdmin) renderAdminDashboard();
            }
        }

        // Reset all user names to defaults
        async function resetUserNames() {
            if (!confirm("Are you sure you want to reset all user names to defaults?")) return;
            
            householdData.users.forEach((user, index) => {
                user.name = `User ${index + 1}`;
            });
            
            await saveAndSync();
            renderSharedView();
            populateDropdowns();
            if (isAdmin) renderAdminDashboard();
        }

        // Reset all data to defaults
        async function resetAllData() {
            if (!confirm("WARNING: This will delete ALL data and reset to defaults. Continue?")) return;
            
            householdData = JSON.parse(JSON.stringify(defaultData));
            await saveAndSync();
            renderSharedView();
            updateWeekDisplay();
            populateDropdowns();
            if (isAdmin) renderAdminDashboard();
        }

        // Update week display
        function updateWeekDisplay() {
            currentWeekSpan.textContent = householdData.currentWeek || 1;
        }

        // Remove a task with validation
        async function removeTask() {
            const taskId = parseInt(taskToRemove.value);
            if (!taskId) return;
            
            householdData.allTasks = householdData.allTasks.filter(task => task.id !== taskId);
            
            householdData.users.forEach(user => {
                user.tasks = user.tasks.filter(task => task.id !== taskId);
            });
            
            await saveAndSync();
            renderSharedView();
            populateDropdowns();
            if (isAdmin) renderAdminDashboard();
        }

        // Unassign task from user with validation
        async function unassignTaskFromUser(taskId, userId) {
            if (!taskId || !userId) return;
            
            const task = householdData.allTasks.find(t => t.id === taskId);
            const user = householdData.users.find(u => u.id === userId);
            
            if (!task || !user) return;
            
            task.assignedUsers = task.assignedUsers.filter(id => id !== userId);
            user.tasks = user.tasks.filter(t => t.id !== taskId);
            
            await saveAndSync();
            renderSharedView();
            if (isAdmin) renderAdminDashboard();
        }

        // Rotate tasks to next week with validation
        async function rotateTasks() {
            if (!householdData.currentWeek) {
                householdData.currentWeek = 1;
            } else {
                householdData.currentWeek++;
            }
            
            householdData.allTasks.forEach(task => {
                if (task.assignedUsers?.length > 0) {
                    // Remove task from all users first
                    householdData.users.forEach(user => {
                        user.tasks = user.tasks.filter(t => t.id !== task.id);
                    });
                    
                    // Rotate assignment
                    const firstUser = task.assignedUsers.shift();
                    task.assignedUsers.push(firstUser);
                    
                    // Reassign to all assigned users
                    task.assignedUsers.forEach(userId => {
                        const user = householdData.users.find(u => u.id === userId);
                        if (user) {
                            user.tasks.push({
                                id: task.id,
                                name: task.name,
                                frequency: task.frequency,
                                completed: false
                            });
                        }
                    });
                }
            });
            
            await saveAndSync();
            renderSharedView();
            updateWeekDisplay();
            if (isAdmin) renderAdminDashboard();
        }

        // Populate all dropdowns with validation
        function populateDropdowns() {
            if (!taskToRemove || !assignTaskSelect || !userToRename || !assignUserSelect) return;
            
            taskToRemove.innerHTML = '<option value="">Select a task</option>';
            assignTaskSelect.innerHTML = '<option value="">Select a task</option>';
            userToRename.innerHTML = '<option value="">Select a user</option>';
            assignUserSelect.innerHTML = '<option value="">Select a user</option>';
            
            householdData.allTasks?.forEach(task => {
                const option1 = document.createElement('option');
                option1.value = task.id;
                option1.textContent = task.name;
                taskToRemove.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = task.id;
                option2.textContent = task.name;
                assignTaskSelect.appendChild(option2);
            });
            
            householdData.users?.forEach(user => {
                const option1 = document.createElement('option');
                option1.value = user.id;
                option1.textContent = user.name;
                assignUserSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = user.id;
                option2.textContent = user.name;
                userToRename.appendChild(option2);
            });
        }

        // Set up tab switching
        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'progress-tracker') {
                        renderAdminDashboard();
                    }
                });
            });
        }

        // Admin dashboard rendering
        function renderAdminDashboard() {
            if (!adminDashboard || !adminMessage) return;
            
            if (!isAdmin) {
                adminDashboard.style.display = "none";
                adminMessage.style.display = "block";
                return;
            }
            
            adminDashboard.style.display = "block";
            adminMessage.style.display = "none";
            if (!progressGrid) return;
            
            progressGrid.innerHTML = '';
            
            householdData.users?.forEach(user => {
                const tasks = user.tasks || [];
                const totalTasks = tasks.length;
                const completedTasks = tasks.filter(t => t?.completed).length;
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                const frequencyStats = {
                    daily: { total: 0, completed: 0 },
                    weekly: { total: 0, completed: 0 },
                    monthly: { total: 0, completed: 0 }
                };
                
                tasks.forEach(task => {
                    if (task.frequency && frequencyStats[task.frequency]) {
                        frequencyStats[task.frequency].total++;
                        if (task.completed) frequencyStats[task.frequency].completed++;
                    }
                });
                
                const card = document.createElement('div');
                card.className = 'progress-card';
                
                card.innerHTML = `
                    <h4>${user.name}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${completionRate}%"></div>
                    </div>
                    <p>${completionRate}% Overall Completion</p>
                    <div class="frequency-stats">
                        <p>Daily: ${frequencyStats.daily.completed}/${frequencyStats.daily.total}</p>
                        <p>Weekly: ${frequencyStats.weekly.completed}/${frequencyStats.weekly.total}</p>
                        <p>Monthly: ${frequencyStats.monthly.completed}/${frequencyStats.monthly.total}</p>
                    </div>
                `;
                
                progressGrid.appendChild(card);
            });
        }

        // Export progress data
        function exportProgressData() {
            if (!isAdmin) return;
            
            const data = {
                timestamp: new Date().toISOString(),
                week: householdData.currentWeek || 1,
                users: householdData.users?.map(user => {
                    const tasks = user.tasks || [];
                    return {
                        name: user.name,
                        completionRate: Math.round((tasks.filter(t => t?.completed).length / tasks.length) * 100) || 0,
                        tasks: tasks.map(task => ({
                            name: task.name,
                            frequency: task.frequency,
                            completed: task.completed,
                            lastUpdated: new Date().toISOString()
                        }))
                    };
                }) || []
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `household-progress-week-${householdData.currentWeek || 1}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Admin features setup
        function setupAdminFeatures() {
            if (!adminToggle || !adminLoginBtn) return;
            
            adminToggle.addEventListener('click', () => {
                adminLoginForm.classList.toggle('hidden');
            });
            
            adminLoginBtn.addEventListener('click', () => {
                if (adminPassword.value === ADMIN_PASSWORD) {
                    isAdmin = true;
                    adminLoginForm.classList.add('hidden');
                    adminToggle.textContent = "Admin Mode (ON)";
                    adminToggle.style.background = "#27ae60";
                    renderAdminDashboard();
                } else {
                    alert("Incorrect password");
                }
            });
            
            if (exportBtn) exportBtn.addEventListener('click', exportProgressData);
            if (resetUsersBtn) resetUsersBtn.addEventListener('click', resetUserNames);
            if (resetDataBtn) resetDataBtn.addEventListener('click', resetAllData);
        }

        // Set up event listeners with validation
        function setupEventListeners() {
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', async () => {
                    const name = newTaskName?.value?.trim();
                    const frequency = newTaskFrequency?.value;
                    
                    if (name && frequency) {
                        await addNewTask(name, frequency);
                        if (newTaskName) newTaskName.value = '';
                    }
                });
            }
            
            if (removeTaskBtn) {
                removeTaskBtn.addEventListener('click', async () => {
                    await removeTask();
                });
            }
            
            if (assignTaskBtn) {
                assignTaskBtn.addEventListener('click', async () => {
                    const taskId = parseInt(assignTaskSelect?.value);
                    const userId = parseInt(assignUserSelect?.value);
                    
                    if (taskId && userId) {
                        await assignTaskToUser(taskId, userId);
                    }
                });
            }
            
            if (unassignTaskBtn) {
                unassignTaskBtn.addEventListener('click', async () => {
                    const taskId = parseInt(assignTaskSelect?.value);
                    const userId = parseInt(assignUserSelect?.value);
                    
                    if (taskId && userId) {
                        await unassignTaskFromUser(taskId, userId);
                    }
                });
            }
            
            if (renameUserBtn) {
                renameUserBtn.addEventListener('click', async () => {
                    const userId = parseInt(userToRename?.value);
                    const newName = newUserName?.value?.trim();
                    
                    if (userId && newName) {
                        await updateUserName(userId, newName);
                        if (newUserName) newUserName.value = '';
                    }
                });
            }
            
            if (rotateBtn) {
                rotateBtn.addEventListener('click', async () => {
                    await rotateTasks();
                });
            }
        }

        // Initialize the app with error handling
        function initApp() {
            try {
                // Load data first
                loadFromDatabase();
                
                // Verify data structure
                verifyDataStructure();
                
                // Setup UI
                renderSharedView();
                updateWeekDisplay();
                populateDropdowns();
                
                // Setup functionality
                setupEventListeners();
                setupTabs();
                setupAdminFeatures();
                
            } catch (error) {
                console.error("App initialization failed:", error);
                if (syncStatus) syncStatus.textContent = "Initialization error - check console";
            }
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
