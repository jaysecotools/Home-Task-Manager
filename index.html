
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Household Chores Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #3a86ff;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.15);
            --radius: 8px;
            --radius-sm: 4px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background-color: #f5f7fa;
            -webkit-text-size-adjust: 100%;
            padding-bottom: 60px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        h1, h2, h3, h4 {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
        }

        h1 {
            font-size: 2rem;
            text-align: center;
            margin: 1.5rem 0;
            color: var(--secondary);
            position: relative;
            padding-bottom: 10px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, var(--primary), var(--success));
            border-radius: 3px;
        }

        h2 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        h3 {
            font-size: 1.25rem;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 10px;
            color: var(--white);
        }

        .badge-primary {
            background-color: var(--primary);
        }

        .badge-secondary {
            background-color: var(--secondary);
        }

        .badge-success {
            background-color: var(--success);
        }

        .badge-danger {
            background-color: var(--danger);
        }

        .badge-warning {
            background-color: var(--warning);
        }

        .badge-info {
            background-color: var(--info);
        }

        .badge-light {
            background-color: var(--light-gray);
            color: var(--dark);
        }

        .badge-dark {
            background-color: var(--dark);
        }

        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            cursor: pointer;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-primary {
            color: var(--white);
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background-color: #3a56e8;
            border-color: #3a56e8;
        }

        .btn-success {
            color: var(--white);
            background-color: var(--success);
            border-color: var(--success);
        }

        .btn-success:hover {
            background-color: #3db5d8;
            border-color: #3db5d8;
        }

        .btn-danger {
            color: var(--white);
            background-color: var(--danger);
            border-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #e51777;
            border-color: #e51777;
        }

        .btn-warning {
            color: var(--white);
            background-color: var(--warning);
            border-color: var(--warning);
        }

        .btn-warning:hover {
            background-color: #e68a1b;
            border-color: #e68a1b;
        }

        .btn-info {
            color: var(--white);
            background-color: var(--info);
            border-color: var(--info);
        }

        .btn-info:hover {
            background-color: #3d87e0;
            border-color: #3d87e0;
        }

        .btn-light {
            color: var(--dark);
            background-color: var(--light-gray);
            border-color: var(--light-gray);
        }

        .btn-light:hover {
            background-color: #d9dde1;
            border-color: #d9dde1;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--dark);
            background-color: var(--white);
            background-clip: padding-box;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius-sm);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: var(--primary-light);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(58, 134, 255, 0.25);
        }

        .user-group {
            margin-bottom: 1.5rem;
        }

        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
        }

        .user-name .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-weight: 600;
        }

        .completion-rate {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            background-color: var(--light);
            transition: var(--transition);
        }

        .task-item:hover {
            background-color: var(--light-gray);
            transform: translateX(5px);
        }

        .task-checkbox {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-name {
            flex-grow: 1;
            word-break: break-word;
            padding: 0.25rem 0;
        }

        .task-name.completed {
            text-decoration: line-through;
            color: var(--gray);
        }

        .task-frequency {
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .week-indicator {
            text-align: center;
            margin: 1.5rem 0;
            font-size: 1rem;
            color: var(--gray);
            background: var(--white);
            padding: 0.75rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .week-indicator span {
            font-weight: 600;
            color: var(--primary);
        }

        .tabs {
            display: flex;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 0.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: var(--light-gray);
            cursor: pointer;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
            transition: var(--transition);
            color: var(--gray);
        }

        .tab:hover {
            background: var(--light);
            color: var(--dark);
        }

        .tab.active {
            background: var(--primary);
            color: var(--white);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .assign-controls {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .assign-controls .btn {
            flex: 1;
        }

        .admin-login {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .admin-login-btn {
            background: var(--dark);
            color: var(--white);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-login-btn i {
            font-size: 1rem;
        }

        .admin-login-form {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--white);
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            width: 250px;
            margin-top: 0.5rem;
            display: none;
        }

        .admin-login-form.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .progress-card {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .progress-card h4 {
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .progress-bar {
            height: 12px;
            background: var(--light-gray);
            border-radius: 6px;
            margin: 0.75rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--success));
            transition: width 0.5s ease;
        }

        .frequency-stats {
            margin-top: 0.75rem;
        }

        .frequency-stats p {
            margin: 0.25rem 0;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
        }

        .frequency-stats span {
            font-weight: 500;
        }

        .sync-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.8rem;
            max-width: 80%;
            word-break: break-word;
            z-index: 1000;
            display: none;
        }

        .sync-status.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .admin-mode .admin-only {
            display: block;
        }

        .non-admin .admin-only {
            display: none;
        }

        /* Avatar colors */
        .avatar-1 { background-color: #4361ee !important; }
        .avatar-2 { background-color: #3f37c9 !important; }
        .avatar-3 { background-color: #4cc9f0 !important; }
        .avatar-4 { background-color: #4895ef !important; }
        .avatar-5 { background-color: #3a86ff !important; }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .progress-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .progress-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .tabs {
                flex-wrap: nowrap;
            }
            
            .tab {
                flex-grow: 0;
                font-size: 0.9rem;
            }
        }

        /* Icons (using Unicode characters as simple icons) */
        .icon {
            font-style: normal;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="non-admin">
    <div class="container">
        <!-- Admin Login Toggle -->
        <div class="admin-login">
            <button class="admin-login-btn" id="admin-toggle">
                <span class="icon">🔑</span> Admin Login
            </button>
            <div class="admin-login-form" id="admin-login-form">
                <div class="form-group">
                    <input type="password" class="form-control" id="admin-password" placeholder="Enter admin password">
                </div>
                <button class="btn btn-primary btn-block" id="admin-login-btn">Login</button>
                <button class="btn btn-danger btn-block hidden" id="admin-logout-btn">Logout</button>
            </div>
        </div>

        <div class="sync-status" id="sync-status">Syncing...</div>

        <h1>Household Chores Manager</h1>
        
        <div class="week-indicator">
            Current Week: <span id="current-week">1</span>
        </div>
        
        <div class="card" id="shared-container">
            <!-- All users' tasks will be displayed here together -->
        </div>
        
        <button class="btn btn-success btn-block admin-only" id="rotate-tasks">Rotate Tasks for Next Week</button>
        
        <div class="card admin-panel admin-only">
            <div class="tabs">
                <div class="tab active" data-tab="add-task">Add Task</div>
                <div class="tab" data-tab="assign-task">Assign Task</div>
                <div class="tab" data-tab="manage-tasks">Manage Tasks</div>
                <div class="tab" data-tab="manage-users">Manage Users</div>
                <div class="tab" data-tab="progress-tracker">Progress</div>
            </div>
            
            <div class="tab-content active" id="add-task">
                <h3>Add New Task</h3>
                <div class="form-group">
                    <label for="new-task-name" class="form-label">Task Name:</label>
                    <input type="text" class="form-control" id="new-task-name" placeholder="Enter task name">
                </div>
                <div class="form-group">
                    <label for="new-task-frequency" class="form-label">Frequency:</label>
                    <select class="form-control" id="new-task-frequency">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-block" id="add-task-btn">Add Task</button>
            </div>
            
            <div class="tab-content" id="assign-task">
                <h3>Assign Task to User</h3>
                <div class="form-group">
                    <label for="assign-task-select" class="form-label">Select Task:</label>
                    <select class="form-control" id="assign-task-select">
                        <!-- Tasks will be populated here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="assign-user-select" class="form-label">Assign to User:</label>
                    <select class="form-control" id="assign-user-select">
                        <!-- Users will be populated here -->
                    </select>
                </div>
                <div class="assign-controls">
                    <button class="btn btn-primary" id="assign-task-btn">Assign Task</button>
                    <button class="btn btn-danger" id="unassign-task-btn">Unassign Task</button>
                </div>
            </div>
            
            <div class="tab-content" id="manage-tasks">
                <h3>Manage Tasks</h3>
                <div class="form-group">
                    <label for="task-to-remove" class="form-label">Select Task to Remove:</label>
                    <select class="form-control" id="task-to-remove">
                        <!-- Tasks will be populated here -->
                    </select>
                </div>
                <button class="btn btn-danger btn-block" id="remove-task-btn">Remove Task</button>
            </div>
            
            <div class="tab-content" id="manage-users">
                <h3>Manage Users</h3>
                <div class="form-group">
                    <label for="user-to-rename" class="form-label">Select User to Rename:</label>
                    <select class="form-control" id="user-to-rename">
                        <!-- Users will be populated here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-user-name" class="form-label">New Name:</label>
                    <input type="text" class="form-control" id="new-user-name" placeholder="Enter new name">
                </div>
                <button class="btn btn-primary btn-block" id="rename-user-btn">Rename User</button>
                <button class="btn btn-warning btn-block" id="reset-users-btn">Reset User Names</button>
            </div>
            
            <div class="tab-content" id="progress-tracker">
                <h3>Progress Monitoring</h3>
                <div class="admin-view" id="admin-dashboard">
                    <h4>Household Completion Rates</h4>
                    <div class="progress-grid" id="progress-grid">
                        <!-- Progress cards will be generated here -->
                    </div>
                    <button class="btn btn-info btn-block" id="export-data">Export Progress Data</button>
                    <button class="btn btn-danger btn-block" id="reset-data-btn">Reset All Data</button>
                </div>
                <div id="admin-message">
                    <p>Please login as admin to view progress tracking.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCi9sLJbYKFTSuw6IvFBePa0gbcQYrqoS8",
            authDomain: "jobs-list-225a7.firebaseapp.com",
            databaseURL: "https://jobs-list-225a7-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jobs-list-225a7",
            storageBucket: "jobs-list-225a7.appspot.com",
            messagingSenderId: "15469992980",
            appId: "1:15469992980:web:e4464c09c183b3f4251b01",
            measurementId: "G-Y1NTGTN88G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'householdData');

        // Configuration
        const ADMIN_PASSWORD = "household123";
        let isAdmin = false;

        // Default data structure
        const defaultData = {
            currentWeek: 1,
            users: [
                { id: 1, name: "User 1", tasks: [] },
                { id: 2, name: "User 2", tasks: [] },
                { id: 3, name: "User 3", tasks: [] },
                { id: 4, name: "User 4", tasks: [] },
                { id: 5, name: "User 5", tasks: [] }
            ],
            allTasks: [],
            lastResetDate: new Date().toISOString()
        };

        // Current app data
        let householdData = JSON.parse(JSON.stringify(defaultData));

        // DOM elements
        const sharedContainer = document.getElementById('shared-container');
        const currentWeekSpan = document.getElementById('current-week');
        const rotateBtn = document.getElementById('rotate-tasks');
        const addTaskBtn = document.getElementById('add-task-btn');
        const removeTaskBtn = document.getElementById('remove-task-btn');
        const assignTaskBtn = document.getElementById('assign-task-btn');
        const unassignTaskBtn = document.getElementById('unassign-task-btn');
        const renameUserBtn = document.getElementById('rename-user-btn');
        const resetUsersBtn = document.getElementById('reset-users-btn');
        const resetDataBtn = document.getElementById('reset-data-btn');
        const newTaskName = document.getElementById('new-task-name');
        const newTaskFrequency = document.getElementById('new-task-frequency');
        const taskToRemove = document.getElementById('task-to-remove');
        const assignTaskSelect = document.getElementById('assign-task-select');
        const assignUserSelect = document.getElementById('assign-user-select');
        const userToRename = document.getElementById('user-to-rename');
        const newUserName = document.getElementById('new-user-name');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const syncStatus = document.getElementById('sync-status');
        const adminToggle = document.getElementById('admin-toggle');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminPassword = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminMessage = document.getElementById('admin-message');
        const progressGrid = document.getElementById('progress-grid');
        const exportBtn = document.getElementById('export-data');
        const body = document.body;

        // Verify and repair data structure
        function verifyDataStructure() {
            if (!householdData) {
                householdData = JSON.parse(JSON.stringify(defaultData));
                return;
            }
            
            // Ensure currentWeek exists
            if (typeof householdData.currentWeek !== 'number') {
                householdData.currentWeek = defaultData.currentWeek;
            }
            
            // Ensure lastResetDate exists
            if (!householdData.lastResetDate) {
                householdData.lastResetDate = new Date().toISOString();
            }
            
            // Ensure users array exists and is properly structured
            if (!Array.isArray(householdData.users)) {
                householdData.users = JSON.parse(JSON.stringify(defaultData.users));
            } else {
                householdData.users.forEach(user => {
                    if (!user.id) user.id = Date.now();
                    if (!user.name) user.name = `User ${user.id}`;
                    if (!Array.isArray(user.tasks)) user.tasks = [];
                    
                    // Ensure each task has lastCompleted property
                    user.tasks.forEach(task => {
                        if (!task.lastCompleted) task.lastCompleted = null;
                    });
                });
            }
            
            // Ensure allTasks array exists and is properly structured
            if (!Array.isArray(householdData.allTasks)) {
                householdData.allTasks = [];
            } else {
                householdData.allTasks.forEach(task => {
                    if (!task.id) task.id = Date.now();
                    if (!task.name) task.name = "Unnamed Task";
                    if (!task.frequency) task.frequency = "weekly";
                    if (!Array.isArray(task.assignedUsers)) task.assignedUsers = [];
                });
            }
        }

        // Check if tasks need to be reset based on their frequency
        function checkForTaskResets() {
            const now = new Date();
            const lastResetDate = new Date(householdData.lastResetDate);
            const needsReset = {
                daily: false,
                weekly: false,
                monthly: false
            };

            // Check daily reset (if it's a new day)
            if (now.getDate() !== lastResetDate.getDate() || 
                now.getMonth() !== lastResetDate.getMonth() || 
                now.getFullYear() !== lastResetDate.getFullYear()) {
                needsReset.daily = true;
            }

            // Check weekly reset (if it's a new week and it's Sunday)
            if (now.getDay() === 0 && (now.getDate() !== lastResetDate.getDate() || 
                                       now.getMonth() !== lastResetDate.getMonth() || 
                                       now.getFullYear() !== lastResetDate.getFullYear())) {
                needsReset.weekly = true;
            }

            // Check monthly reset (if it's the 1st of the month)
            if (now.getDate() === 1 && (now.getMonth() !== lastResetDate.getMonth() || 
                                       now.getFullYear() !== lastResetDate.getFullYear())) {
                needsReset.monthly = true;
            }

            // If any reset is needed, update the tasks
            if (needsReset.daily || needsReset.weekly || needsReset.monthly) {
                householdData.users.forEach(user => {
                    user.tasks.forEach(task => {
                        if ((task.frequency === 'daily' && needsReset.daily) ||
                            (task.frequency === 'weekly' && needsReset.weekly) ||
                            (task.frequency === 'monthly' && needsReset.monthly)) {
                            task.completed = false;
                            task.lastCompleted = null;
                        }
                    });
                });

                // Update last reset date
                householdData.lastResetDate = now.toISOString();
                return true;
            }
            return false;
        }

        // Save to Realtime Database
        async function saveToDatabase() {
            try {
                showSyncStatus("Saving to cloud...");
                await set(dbRef, householdData);
                showSyncStatus("Synced");
                setTimeout(() => hideSyncStatus(), 2000);
            } catch (error) {
                console.error("Error saving to database:", error);
                showSyncStatus("Sync failed: " + error.message);
            }
        }

        // Show sync status
        function showSyncStatus(message) {
            syncStatus.textContent = message;
            syncStatus.classList.add('show');
        }

        // Hide sync status
        function hideSyncStatus() {
            syncStatus.classList.remove('show');
        }

        // Load from Realtime Database with improved error handling
        function loadFromDatabase() {
            showSyncStatus("Loading from cloud...");
            
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                console.log("Data received from Firebase:", data);
                
                if (data) {
                    // Merge with default structure to ensure all required fields exist
                    householdData = {
                        currentWeek: data.currentWeek || defaultData.currentWeek,
                        users: data.users || JSON.parse(JSON.stringify(defaultData.users)),
                        allTasks: data.allTasks || [],
                        lastResetDate: data.lastResetDate || new Date().toISOString()
                    };
                    
                    verifyDataStructure();
                    
                    // Check for task resets when loading
                    const resetPerformed = checkForTaskResets();
                    if (resetPerformed) {
                        saveToDatabase();
                    }
                    
                    saveDataLocally();
                    renderSharedView();
                    updateWeekDisplay();
                    populateDropdowns();
                    if (isAdmin) renderAdminDashboard();
                } else {
                    // No data exists - initialize with defaults
                    console.log("No data found, initializing new database");
                    householdData = JSON.parse(JSON.stringify(defaultData));
                    saveToDatabase();
                }
                
                showSyncStatus("Synced");
                setTimeout(() => hideSyncStatus(), 2000);
            }, (error) => {
                console.error("Error loading data:", error);
                showSyncStatus("Sync failed, using local data");
                
                // Fallback to local data with proper initialization
                const saved = localStorage.getItem('householdChoresData');
                householdData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultData));
                verifyDataStructure();
                
                // Check for task resets when loading local data
                const resetPerformed = checkForTaskResets();
                if (resetPerformed) {
                    saveDataLocally();
                }
                
                renderSharedView();
            });
        }

        // Save to localStorage
        function saveDataLocally() {
            localStorage.setItem('householdChoresData', JSON.stringify(householdData));
        }

        // Combined save function
        async function saveAndSync() {
            verifyDataStructure();
            saveDataLocally();
            await saveToDatabase();
        }

        // Add a new task with validation
        async function addNewTask(name, frequency) {
            if (!name || !frequency) return;
            
            const newTask = {
                id: Date.now(),
                name: name.trim(),
                frequency: frequency,
                assignedUsers: []
            };
            
            if (!householdData.allTasks) {
                householdData.allTasks = [];
            }
            
            householdData.allTasks.push(newTask);
            await saveAndSync();
            populateDropdowns();
            newTaskName.value = '';
            newTaskName.focus();
        }

        // Assign task to user with validation
        async function assignTaskToUser(taskId, userId) {
            if (!taskId || !userId) return;
            
            const task = householdData.allTasks.find(t => t.id === taskId);
            const user = householdData.users.find(u => u.id === userId);
            
            if (!task || !user) return;
            
            // Initialize arrays if they don't exist
            if (!task.assignedUsers) task.assignedUsers = [];
            if (!user.tasks) user.tasks = [];
            
            if (!task.assignedUsers.includes(userId)) {
                task.assignedUsers.push(userId);
            }
            
            if (!user.tasks.some(t => t.id === taskId)) {
                user.tasks.push({
                    id: task.id,
                    name: task.name,
                    frequency: task.frequency,
                    completed: false,
                    lastCompleted: null
                });
            }
            
            await saveAndSync();
            renderSharedView();
            if (isAdmin) renderAdminDashboard();
        }

        // Render shared view of all users' tasks
        function renderSharedView() {
            sharedContainer.innerHTML = '';
            
            if (!householdData?.users) {
                console.error("Users data is missing!");
                return;
            }
            
            // Use current data or fallback to defaults
            const users = householdData.users.length > 0 ? householdData.users : defaultData.users;
            
            users.forEach((user, index) => {
                const tasks = user.tasks || [];
                const totalTasks = tasks.length;
                const completedTasks = tasks.filter(t => t?.completed).length;
                const completionRate = totalTasks > 0 
                    ? Math.round((completedTasks / totalTasks) * 100) 
                    : 0;
                
                const userGroup = document.createElement('div');
                userGroup.className = 'user-group';
                
                const userHeader = document.createElement('div');
                userHeader.className = 'user-header';
                
                const userName = document.createElement('div');
                userName.className = 'user-name';
                
                const avatar = document.createElement('div');
                avatar.className = `avatar avatar-${index + 1}`;
                avatar.textContent = user.name.charAt(0).toUpperCase();
                
                userName.appendChild(avatar);
                userName.appendChild(document.createTextNode(user.name));
                
                const completionBadge = document.createElement('div');
                completionBadge.className = 'completion-rate';
                completionBadge.innerHTML = `<span class="badge ${getCompletionBadgeClass(completionRate)}">${completionRate}% completed</span>`;
                
                userHeader.appendChild(userName);
                userHeader.appendChild(completionBadge);
                userGroup.appendChild(userHeader);
                
                const taskList = document.createElement('ul');
                taskList.className = 'task-list';
                
                if (tasks.length === 0) {
                    const emptyMessage = document.createElement('li');
                    emptyMessage.className = 'task-item';
                    emptyMessage.textContent = 'No tasks assigned';
                    taskList.appendChild(emptyMessage);
                } else {
                    tasks.forEach(task => {
                        const taskItem = document.createElement('li');
                        taskItem.className = 'task-item';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'task-checkbox';
                        checkbox.checked = task.completed || false;
                        checkbox.addEventListener('change', async () => {
                            task.completed = checkbox.checked;
                            task.lastCompleted = task.completed ? new Date().toISOString() : null;
                            await saveAndSync();
                            renderSharedView();
                            if (isAdmin) renderAdminDashboard();
                        });
                        
                        const taskName = document.createElement('span');
                        taskName.className = `task-name ${task.completed ? 'completed' : ''}`;
                        taskName.textContent = task.name;
                        
                        const frequencyBadge = document.createElement('span');
                        frequencyBadge.className = `badge ${getFrequencyBadgeClass(task.frequency)} task-frequency`;
                        frequencyBadge.textContent = task.frequency;
                        
                        taskItem.appendChild(checkbox);
                        taskItem.appendChild(taskName);
                        taskItem.appendChild(frequencyBadge);
                        taskList.appendChild(taskItem);
                    });
                }
                
                userGroup.appendChild(taskList);
                sharedContainer.appendChild(userGroup);
            });
        }

        // Get badge class based on completion rate
        function getCompletionBadgeClass(rate) {
            if (rate >= 80) return 'badge-success';
            if (rate >= 50) return 'badge-warning';
            return 'badge-danger';
        }

        // Get badge class based on frequency
        function getFrequencyBadgeClass(frequency) {
            switch (frequency) {
                case 'daily': return 'badge-primary';
                case 'weekly': return 'badge-info';
                case 'monthly': return 'badge-secondary';
                default: return 'badge-light';
            }
        }

        // Update user name with validation
        async function updateUserName(userId, newName) {
            if (!userId || !newName) return;
            
            const user = householdData.users.find(u => u.id === userId);
            if (user && newName.trim()) {
                user.name = newName.trim();
                await saveAndSync();
                renderSharedView();
                populateDropdowns();
                if (isAdmin) renderAdminDashboard();
                newUserName.value = '';
            }
        }

        // Reset all user names to defaults
        async function resetUserNames() {
            if (!confirm("Are you sure you want to reset all user names to defaults?")) return;
            
            householdData.users.forEach((user, index) => {
                user.name = `User ${index + 1}`;
            });
            
            await saveAndSync();
            renderSharedView();
            populateDropdowns();
            if (isAdmin) renderAdminDashboard();
        }

        // Reset all data to defaults
        async function resetAllData() {
            if (!confirm("WARNING: This will delete ALL data and reset to defaults. Continue?")) return;
            
            householdData = JSON.parse(JSON.stringify(defaultData));
            await saveAndSync();
            renderSharedView();
            updateWeekDisplay();
            populateDropdowns();
            if (isAdmin) renderAdminDashboard();
        }

        // Update week display
        function updateWeekDisplay() {
            currentWeekSpan.textContent = householdData.currentWeek || 1;
        }

        // Remove a task with validation
        async function removeTask() {
            const taskId = parseInt(taskToRemove.value);
            if (!taskId) return;
            
            if (!confirm("Are you sure you want to remove this task? This will also unassign it from all users.")) return;
            
            householdData.allTasks = householdData.allTasks.filter(task => task.id !== taskId);
            
            householdData.users.forEach(user => {
                user.tasks = user.tasks.filter(task => task.id !== taskId);
            });
            
            await saveAndSync();
            renderSharedView();
            populateDropdowns();
            if (isAdmin) renderAdminDashboard();
        }

        // Unassign task from user with validation
        async function unassignTaskFromUser(taskId, userId) {
            if (!taskId || !userId) return;
            
            const task = householdData.allTasks.find(t => t.id === taskId);
            const user = householdData.users.find(u => u.id === userId);
            
            if (!task || !user) return;
            
            task.assignedUsers = task.assignedUsers.filter(id => id !== userId);
            user.tasks = user.tasks.filter(t => t.id !== taskId);
            
            await saveAndSync();
            renderSharedView();
            if (isAdmin) renderAdminDashboard();
        }

        // Rotate tasks to next week with validation
        async function rotateTasks() {
            if (!confirm("Are you sure you want to rotate tasks to the next week?")) return;
            
            if (!householdData.currentWeek) {
                householdData.currentWeek = 1;
            } else {
                householdData.currentWeek++;
            }
            
            householdData.allTasks.forEach(task => {
                if (task.assignedUsers?.length > 0) {
                    // Remove task from all users first
                    householdData.users.forEach(user => {
                        user.tasks = user.tasks.filter(t => t.id !== task.id);
                    });
                    
                    // Rotate assignment
                    const firstUser = task.assignedUsers.shift();
                    task.assignedUsers.push(firstUser);
                    
                    // Reassign to all assigned users
                    task.assignedUsers.forEach(userId => {
                        const user = householdData.users.find(u => u.id === userId);
                        if (user) {
                            user.tasks.push({
                                id: task.id,
                                name: task.name,
                                frequency: task.frequency,
                                completed: false,
                                lastCompleted: null
                            });
                        }
                    });
                }
            });
            
            await saveAndSync();
            renderSharedView();
            updateWeekDisplay();
            if (isAdmin) renderAdminDashboard();
        }

        // Populate all dropdowns with validation
        function populateDropdowns() {
            if (!taskToRemove || !assignTaskSelect || !userToRename || !assignUserSelect) return;
            
            taskToRemove.innerHTML = '<option value="">Select a task</option>';
            assignTaskSelect.innerHTML = '<option value="">Select a task</option>';
            userToRename.innerHTML = '<option value="">Select a user</option>';
            assignUserSelect.innerHTML = '<option value="">Select a user</option>';
            
            householdData.allTasks?.forEach(task => {
                const option1 = document.createElement('option');
                option1.value = task.id;
                option1.textContent = task.name;
                taskToRemove.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = task.id;
                option2.textContent = task.name;
                assignTaskSelect.appendChild(option2);
            });
            
            householdData.users?.forEach(user => {
                const option1 = document.createElement('option');
                option1.value = user.id;
                option1.textContent = user.name;
                assignUserSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = user.id;
                option2.textContent = user.name;
                userToRename.appendChild(option2);
            });
        }

        // Set up tab switching
        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'progress-tracker') {
                        renderAdminDashboard();
                    }
                });
            });
        }

        // Admin dashboard rendering
        function renderAdminDashboard() {
            if (!adminDashboard || !adminMessage) return;
            
            if (!isAdmin) {
                adminDashboard.style.display = "none";
                adminMessage.style.display = "block";
                return;
            }
            
            adminDashboard.style.display = "block";
            adminMessage.style.display = "none";
            if (!progressGrid) return;
            
            progressGrid.innerHTML = '';
            
            householdData.users?.forEach((user, index) => {
                const tasks = user.tasks || [];
                const totalTasks = tasks.length;
                const completedTasks = tasks.filter(t => t?.completed).length;
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                const frequencyStats = {
                    daily: { total: 0, completed: 0 },
                    weekly: { total: 0, completed: 0 },
                    monthly: { total: 0, completed: 0 }
                };
                
                tasks.forEach(task => {
                    if (task.frequency && frequencyStats[task.frequency]) {
                        frequencyStats[task.frequency].total++;
                        if (task.completed) frequencyStats[task.frequency].completed++;
                    }
                });
                
                const card = document.createElement('div');
                card.className = 'progress-card';
                
                const avatar = document.createElement('div');
                avatar.className = `avatar avatar-${index + 1}`;
                avatar.textContent = user.name.charAt(0).toUpperCase();
                
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        ${avatar.outerHTML}
                        <h4 style="margin: 0;">${user.name}</h4>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${completionRate}%"></div>
                    </div>
                    <p style="text-align: center; font-weight: 500; margin: 0.5rem 0;">${completionRate}% Overall Completion</p>
                    <div class="frequency-stats">
                        <p><span>Daily:</span> <span>${frequencyStats.daily.completed}/${frequencyStats.daily.total}</span></p>
                        <p><span>Weekly:</span> <span>${frequencyStats.weekly.completed}/${frequencyStats.weekly.total}</span></p>
                        <p><span>Monthly:</span> <span>${frequencyStats.monthly.completed}/${frequencyStats.monthly.total}</span></p>
                    </div>
                `;
                
                progressGrid.appendChild(card);
            });
        }

        // Export progress data
        function exportProgressData() {
            if (!isAdmin) return;
            
            const data = {
                timestamp: new Date().toISOString(),
                week: householdData.currentWeek || 1,
                lastResetDate: householdData.lastResetDate,
                users: householdData.users?.map(user => {
                    const tasks = user.tasks || [];
                    return {
                        name: user.name,
                        completionRate: Math.round((tasks.filter(t => t?.completed).length / tasks.length) * 100) || 0,
                        tasks: tasks.map(task => ({
                            name: task.name,
                            frequency: task.frequency,
                            completed: task.completed,
                            lastCompleted: task.lastCompleted || "Never"
                        }))
                    };
                }) || []
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `household-progress-week-${householdData.currentWeek || 1}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Admin features setup
        function setupAdminFeatures() {
            if (!adminToggle || !adminLoginBtn || !adminLogoutBtn) return;
            
            adminToggle.addEventListener('click', () => {
                adminLoginForm.classList.toggle('show');
            });
            
            adminLoginBtn.addEventListener('click', () => {
                if (adminPassword.value === ADMIN_PASSWORD) {
                    isAdmin = true;
                    adminLoginForm.classList.remove('show');
                    adminToggle.innerHTML = '<span class="icon">👑</span> Admin Mode';
                    adminToggle.classList.add('btn-success');
                    adminLogoutBtn.classList.remove('hidden');
                    adminLoginBtn.classList.add('hidden');
                    body.classList.remove('non-admin');
                    body.classList.add('admin-mode');
                    renderAdminDashboard();
                    adminPassword.value = '';
                } else {
                    alert("Incorrect password");
                }
            });
            
            adminLogoutBtn.addEventListener('click', () => {
                isAdmin = false;
                adminToggle.innerHTML = '<span class="icon">🔑</span> Admin Login';
                adminToggle.classList.remove('btn-success');
                adminLogoutBtn.classList.add('hidden');
                adminLoginBtn.classList.remove('hidden');
                adminPassword.value = "";
                body.classList.remove('admin-mode');
                body.classList.add('non-admin');
                renderAdminDashboard();
            });
            
            if (exportBtn) exportBtn.addEventListener('click', exportProgressData);
            if (resetUsersBtn) resetUsersBtn.addEventListener('click', resetUserNames);
            if (resetDataBtn) resetDataBtn.addEventListener('click', resetAllData);
        }

        // Set up event listeners with validation
        function setupEventListeners() {
            // Add task
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', async () => {
                    const name = newTaskName?.value?.trim();
                    const frequency = newTaskFrequency?.value;
                    
                    if (name && frequency) {
                        await addNewTask(name, frequency);
                    } else {
                        alert("Please enter a task name and select frequency");
                    }
                });
                
                // Allow adding task with Enter key
                newTaskName.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const name = newTaskName?.value?.trim();
                        const frequency = newTaskFrequency?.value;
                        
                        if (name && frequency) {
                            await addNewTask(name, frequency);
                        }
                    }
                });
            }
            
            // Remove task
            if (removeTaskBtn) {
                removeTaskBtn.addEventListener('click', async () => {
                    await removeTask();
                });
            }
            
            // Assign task
            if (assignTaskBtn) {
                assignTaskBtn.addEventListener('click', async () => {
                    const taskId = parseInt(assignTaskSelect?.value);
                    const userId = parseInt(assignUserSelect?.value);
                    
                    if (taskId && userId) {
                        await assignTaskToUser(taskId, userId);
                    } else {
                        alert("Please select both a task and a user");
                    }
                });
            }
            
            // Unassign task
            if (unassignTaskBtn) {
                unassignTaskBtn.addEventListener('click', async () => {
                    const taskId = parseInt(assignTaskSelect?.value);
                    const userId = parseInt(assignUserSelect?.value);
                    
                    if (taskId && userId) {
                        await unassignTaskFromUser(taskId, userId);
                    } else {
                        alert("Please select both a task and a user");
                    }
                });
            }
            
            // Rename user
            if (renameUserBtn) {
                renameUserBtn.addEventListener('click', async () => {
                    const userId = parseInt(userToRename?.value);
                    const newName = newUserName?.value?.trim();
                    
                    if (userId && newName) {
                        await updateUserName(userId, newName);
                    } else {
                        alert("Please select a user and enter a new name");
                    }
                });
                
                // Allow renaming with Enter key
                newUserName.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const userId = parseInt(userToRename?.value);
                        const newName = newUserName?.value?.trim();
                        
                        if (userId && newName) {
                            await updateUserName(userId, newName);
                        }
                    }
                });
            }
            
            // Rotate tasks
            if (rotateBtn) {
                rotateBtn.addEventListener('click', async () => {
                    await rotateTasks();
                });
            }
        }

        // Initialize the app with error handling
        function initApp() {
            try {
                // Load data first
                loadFromDatabase();
                
                // Verify data structure
                verifyDataStructure();
                
                // Setup UI
                renderSharedView();
                updateWeekDisplay();
                populateDropdowns();
                
                // Setup functionality
                setupEventListeners();
                setupTabs();
                setupAdminFeatures();
                
                // Check for task resets periodically (every hour)
                setInterval(() => {
                    const resetPerformed = checkForTaskResets();
                    if (resetPerformed) {
                        saveAndSync();
                        renderSharedView();
                        if (isAdmin) renderAdminDashboard();
                    }
                }, 3600000); // 1 hour in milliseconds
                
            } catch (error) {
                console.error("App initialization failed:", error);
                showSyncStatus("Initialization error - check console");
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
